<div class="min-h-screen bg-gray-50" *ngIf="state$ | async as state">
  <!-- Page Header -->
  <div class="bg-white border-b border-gray-200 px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Accounts</h1>
      <p class="text-sm sm:text-base text-gray-600 mt-1">View all customer accounts</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Filters -->
    <mat-card class="mb-6">
      <div class="p-4">
        <!-- Primary Filters Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Account UUID Field -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Account UUID</mat-label>
            <input
              matInput
              [formControl]="accountUuidControl"
              placeholder="Enter exact account UUID..."
              class="font-mono text-sm"
            />
            <mat-hint>Search by exact account identifier</mat-hint>
            <button
              mat-icon-button
              matSuffix
              *ngIf="accountUuidControl.value"
              (click)="accountUuidControl.setValue('')"
              matTooltip="Clear UUID"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>

          <!-- Account Label Search -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Account Label</mat-label>
            <input
              matInput
              [formControl]="searchControl"
              placeholder="Search by account label..."
            />
            <mat-icon matPrefix class="text-indigo-600">badge</mat-icon>
            <mat-hint>Partial match on account label</mat-hint>
            <button
              mat-icon-button
              matSuffix
              *ngIf="searchControl.value"
              (click)="searchControl.setValue('')"
              matTooltip="Clear search"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>

        <!-- Secondary Filters Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Status Filter -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Status</mat-label>
            <mat-select [formControl]="statusFilter">
              <mat-option value="all">All Statuses</mat-option>
              <mat-option value="active">Active</mat-option>
              <mat-option value="inactive">Inactive</mat-option>
            </mat-select>
            <mat-icon matPrefix>filter_list</mat-icon>
          </mat-form-field>

          <!-- Workflow Filter -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Workflow Title</mat-label>
            <input matInput [formControl]="workflowFilter" placeholder="Exact workflow name..." />
            <mat-icon matPrefix class="text-indigo-600">autorenew</mat-icon>
            <mat-hint>Case-insensitive exact match</mat-hint>
            <button
              mat-icon-button
              matSuffix
              *ngIf="workflowFilter.value"
              (click)="workflowFilter.setValue('')"
              matTooltip="Clear workflow"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>

          <!-- Spacer for alignment -->
          <div class="hidden md:block"></div>

          <!-- Clear Filters Button -->
          <div class="flex items-end">
            <button
              mat-stroked-button
              (click)="clearFilters()"
              class="h-14 w-full"
              [disabled]="
                !accountUuidControl.value &&
                !searchControl.value &&
                statusFilter.value === 'all' &&
                !workflowFilter.value
              "
            >
              <mat-icon class="mr-2">clear_all</mat-icon>
              Clear All Filters
            </button>
          </div>
        </div>

        <!-- Active Filters Chips -->
        <div
          *ngIf="
            accountUuidControl.value ||
            searchControl.value ||
            workflowFilter.value ||
            statusFilter.value !== 'all'
          "
          class="mt-4 flex flex-wrap gap-2 pt-4 border-t border-gray-200"
        >
          <div class="text-xs font-medium text-gray-600 flex items-center mr-2">
            <mat-icon class="text-sm mr-1">filter_alt</mat-icon>
            Active Filters:
          </div>

          <mat-chip *ngIf="accountUuidControl.value" class="text-xs h-8">
            UUID: {{ accountUuidControl.value.substring(0, 8) }}...
            <button matChipRemove (click)="accountUuidControl.setValue('')">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>

          <mat-chip *ngIf="searchControl.value" class="text-xs h-8">
            <mat-icon class="text-sm mr-1">badge</mat-icon>
            Label: "{{ searchControl.value }}"
            <button matChipRemove (click)="searchControl.setValue('')">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>

          <mat-chip *ngIf="statusFilter.value !== 'all'" class="text-xs h-8">
            <mat-icon class="text-sm mr-1">info</mat-icon>
            Status: {{ statusFilter.value }}
            <button matChipRemove (click)="statusFilter.setValue('all')">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>

          <mat-chip *ngIf="workflowFilter.value" class="text-xs h-8">
            <mat-icon class="text-sm mr-1">autorenew</mat-icon>
            Workflow: {{ workflowFilter.value }}
            <button matChipRemove (click)="workflowFilter.setValue('')">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
        </div>

        <!-- Results Summary -->
        <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
          <span *ngIf="state.pageData">
            Showing <strong>{{ state.pageData.items.length }}</strong> of
            <strong>{{ state.pageData.total_items }}</strong> accounts
            <span class="text-gray-400 mx-2">â€¢</span>
            Page <strong>{{ state.pageData.page }}</strong> of
            <strong>{{ state.pageData.total_pages }}</strong>
          </span>
        </div>
      </div>
    </mat-card>

    <!-- Loading State -->
    <app-loading-spinner *ngIf="state.isLoading" [diameter]="60" message="Loading accounts..." />

    <!-- Error State -->
    <mat-card *ngIf="state.error && !state.isLoading">
      <div class="p-12 text-center">
        <mat-icon class="text-6xl text-red-400 mb-4">error</mat-icon>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Accounts</h3>
        <p class="text-gray-600 mb-4">{{ state.error }}</p>
        <button mat-raised-button color="primary" (click)="loadAccounts()">
          <mat-icon class="mr-2">refresh</mat-icon>
          Retry
        </button>
      </div>
    </mat-card>

    <!-- Table -->
    <mat-card
      *ngIf="!state.isLoading && !state.error && state.pageData && state.pageData.items.length > 0"
    >
      <div class="overflow-x-auto">
        <table
          mat-table
          [dataSource]="state.pageData.items"
          matSort
          (matSortChange)="onSort($event)"
          class="w-full"
        >
          <!-- Account Label Column -->
          <ng-container matColumnDef="account_label">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">Account</th>
            <td mat-cell *matCellDef="let account" class="py-4">
              <div>
                <p class="font-medium text-gray-900">{{ account.account_label }}</p>
                <p class="text-xs text-gray-500 font-mono">{{ account.account_uuid }}</p>

                <!-- Workflows -->
                <div *ngIf="account.workflows.count > 0" class="mt-2">
                  <!-- Single workflow -->
                  <div
                    *ngIf="account.workflows.count === 1"
                    class="flex items-center gap-1 text-xs text-gray-600"
                  >
                    <mat-icon class="text-xs text-purple-600">autorenew</mat-icon>
                    {{ account.workflows.titles[0] }}
                  </div>

                  <!-- Multiple workflows with menu -->
                  <button
                    *ngIf="account.workflows.count > 1"
                    mat-button
                    [matMenuTriggerFor]="workflowMenu"
                    class="text-xs px-2 py-1 min-w-0 h-auto"
                  >
                    <mat-icon class="text-xs mr-1 text-purple-600">autorenew</mat-icon>
                    {{ account.workflows.count }} Workflows
                    <mat-icon class="text-xs ml-1">arrow_drop_down</mat-icon>
                  </button>

                  <mat-menu #workflowMenu="matMenu">
                    <button
                      mat-menu-item
                      *ngFor="let workflow of account.workflows.titles"
                      class="text-sm"
                    >
                      <mat-icon class="text-purple-600">autorenew</mat-icon>
                      <span>{{ workflow }}</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="subscription_status">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Status</th>
            <td mat-cell *matCellDef="let account">
              <span
                [ngClass]="getStatusColor(account.subscription.status)"
                class="px-2 py-1 rounded-full text-xs font-medium capitalize"
              >
                {{ account.subscription.status }}
              </span>
            </td>
          </ng-container>

          <!-- Seats Column -->
          <ng-container matColumnDef="seats">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Seats</th>
            <td mat-cell *matCellDef="let account">
              <div class="text-sm">
                <div class="font-medium text-gray-900 mb-2">{{ getTotalSeats(account) }} total</div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                  <div class="text-center">
                    <div class="text-indigo-600 font-bold">
                      {{ account.subscription.admin_seats }}
                    </div>
                    <div class="text-gray-500">Admin</div>
                  </div>
                  <div class="text-center">
                    <div class="text-blue-600 font-bold">{{ account.subscription.user_seats }}</div>
                    <div class="text-gray-500">User</div>
                  </div>
                  <div class="text-center">
                    <div class="text-gray-600 font-bold">
                      {{ account.subscription.read_only_seats }}
                    </div>
                    <div class="text-gray-500">View</div>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Records Column -->
          <ng-container matColumnDef="records">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">Records</th>
            <td mat-cell *matCellDef="let account">
              <span class="font-medium">{{ formatNumber(account.usage.total_records) }}</span>
            </td>
          </ng-container>

          <!-- Automations Column -->
          <ng-container matColumnDef="automations">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
              Automations
            </th>
            <td mat-cell *matCellDef="let account">
              <span class="font-medium">{{ account.usage.automation_count }}</span>
            </td>
          </ng-container>

          <!-- Messages Column -->
          <ng-container matColumnDef="messages">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
              Messages
            </th>
            <td mat-cell *matCellDef="let account">
              <span class="font-medium">{{ formatNumber(account.usage.messages_processed) }}</span>
            </td>
          </ng-container>

          <!-- Notifications Column -->
          <ng-container matColumnDef="notifications">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">
              Notifications
            </th>
            <td mat-cell *matCellDef="let account">
              <div class="text-sm">
                <div class="font-medium text-gray-900">
                  {{ formatNumber(account.usage.notifications_sent) }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ formatNumber(account.usage.notifications_billed) }} billed
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            class="hover:bg-gray-50 cursor-pointer transition-colors"
          ></tr>
        </table>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [length]="state.pageData.total_items"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="page - 1"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </mat-card>

    <!-- Empty State -->
    <mat-card
      *ngIf="
        !state.isLoading && !state.error && state.pageData && state.pageData.items.length === 0
      "
    >
      <div class="p-12 text-center">
        <mat-icon class="text-6xl text-gray-400 mb-4">search_off</mat-icon>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No accounts found</h3>
        <p class="text-gray-600 mb-4">Try adjusting your search criteria or filters.</p>
        <button mat-raised-button color="primary" (click)="clearFilters()">
          <mat-icon class="mr-2">clear_all</mat-icon>
          Clear All Filters
        </button>
      </div>
    </mat-card>
  </div>
</div>
